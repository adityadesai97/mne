# mne Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a personal finance PWA called mne that tracks a multi-asset portfolio across iOS and macOS using Supabase for storage, Claude for natural language commands, and Finnhub for live stock prices.

**Architecture:** React SPA scaffolded with Vite, served as a PWA installable on iOS and macOS. All data lives in the user's own Supabase Postgres instance with RLS. A ⌘K command bar sends natural language to Claude (via the user's API key), which returns structured navigation or write actions. Push notifications are sent via Supabase Edge Functions triggered by pg_cron.

**Tech Stack:** Vite + React 18 + TypeScript, shadcn/ui + Tailwind CSS, Supabase JS v2, Anthropic JS SDK, vite-plugin-pwa, Vitest + React Testing Library, React Router v6

---

## Phase 1: Project Foundation

### Task 1: Scaffold Vite + React + TypeScript

**Files:**
- Create: `package.json`
- Create: `vite.config.ts`
- Create: `tsconfig.json`
- Create: `src/main.tsx`
- Create: `src/App.tsx`

**Step 1: Scaffold the project**

```bash
npm create vite@latest . -- --template react-ts
npm install
```

**Step 2: Install core dependencies**

```bash
npm install @supabase/supabase-js @anthropic-ai/sdk react-router-dom recharts
npm install -D vitest @testing-library/react @testing-library/jest-dom @testing-library/user-event jsdom
```

**Step 3: Install PWA plugin**

```bash
npm install -D vite-plugin-pwa workbox-window
```

**Step 4: Configure vite.config.ts**

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'mne',
        short_name: 'mne',
        description: 'Personal finance tracker',
        theme_color: '#0D0D0D',
        background_color: '#0D0D0D',
        display: 'standalone',
        icons: [
          { src: '/icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: '/icon-512.png', sizes: '512x512', type: 'image/png' },
        ],
      },
    }),
  ],
})
```

**Step 5: Configure vitest in vite.config.ts**

Add to the config:
```typescript
test: {
  environment: 'jsdom',
  setupFiles: ['./src/test-setup.ts'],
  globals: true,
}
```

**Step 6: Create test setup file**

```typescript
// src/test-setup.ts
import '@testing-library/jest-dom'
```

**Step 7: Verify dev server starts**

```bash
npm run dev
```
Expected: App running at http://localhost:5173

**Step 8: Commit**

```bash
git init
git add .
git commit -m "feat: scaffold Vite + React + TypeScript PWA"
```

---

### Task 2: Configure Tailwind + shadcn/ui Dark Theme

**Files:**
- Create: `tailwind.config.ts`
- Create: `src/index.css`
- Modify: `src/App.tsx`

**Step 1: Install Tailwind**

```bash
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

**Step 2: Install shadcn/ui**

```bash
npx shadcn@latest init
```
When prompted: choose Dark theme, CSS variables, and `src/components/ui` as component path.

**Step 3: Install initial shadcn components**

```bash
npx shadcn@latest add button card dialog sheet tabs badge separator scroll-area
```

**Step 4: Configure Cryptix-inspired dark theme in src/index.css**

Replace the `:root` and `.dark` CSS variables generated by shadcn with:

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 5%;          /* #0D0D0D */
    --foreground: 0 0% 98%;
    --card: 0 0% 9%;                /* #161616 */
    --card-foreground: 0 0% 98%;
    --popover: 0 0% 9%;
    --popover-foreground: 0 0% 98%;
    --primary: 153 100% 50%;        /* neon green #00FF82 */
    --primary-foreground: 0 0% 5%;
    --secondary: 0 0% 14%;
    --secondary-foreground: 0 0% 98%;
    --muted: 0 0% 14%;
    --muted-foreground: 0 0% 60%;
    --accent: 153 100% 50%;
    --accent-foreground: 0 0% 5%;
    --destructive: 0 84% 60%;
    --destructive-foreground: 0 0% 98%;
    --border: 0 0% 14%;
    --input: 0 0% 14%;
    --ring: 153 100% 50%;
    --radius: 0.75rem;
    /* Gain/loss colors */
    --gain: 153 100% 50%;           /* neon green */
    --loss: 0 84% 60%;              /* red */
  }
}

body {
  @apply bg-background text-foreground;
  font-feature-settings: "rlig" 1, "calt" 1;
}
```

**Step 5: Add utility classes for gain/loss to tailwind.config.ts**

```typescript
extend: {
  colors: {
    gain: 'hsl(var(--gain))',
    loss: 'hsl(var(--loss))',
  }
}
```

**Step 6: Write smoke test**

```typescript
// src/__tests__/App.test.tsx
import { render, screen } from '@testing-library/react'
import App from '../App'

test('renders without crashing', () => {
  render(<App />)
  expect(document.body).toBeInTheDocument()
})
```

**Step 7: Run test**

```bash
npm run test
```
Expected: PASS

**Step 8: Commit**

```bash
git add .
git commit -m "feat: configure Tailwind and shadcn/ui with dark Cryptix theme"
```

---

### Task 3: Set Up React Router and App Shell

**Files:**
- Create: `src/router.tsx`
- Create: `src/layouts/AppLayout.tsx`
- Create: `src/layouts/BottomNav.tsx`
- Create: `src/pages/Home.tsx`
- Create: `src/pages/Portfolio.tsx`
- Create: `src/pages/Tax.tsx`
- Create: `src/pages/Watchlist.tsx`
- Create: `src/pages/Settings.tsx`
- Modify: `src/App.tsx`

**Step 1: Create page stubs**

Each page file is a minimal placeholder:
```typescript
// src/pages/Home.tsx
export default function Home() {
  return <div className="p-4"><h1 className="text-2xl font-bold">Home</h1></div>
}
```
Create the same pattern for Portfolio, Tax, Watchlist, and Settings.

**Step 2: Create bottom nav component**

```typescript
// src/layouts/BottomNav.tsx
import { NavLink } from 'react-router-dom'
import { Home, BarChart2, Receipt, Star, Settings } from 'lucide-react'

const tabs = [
  { to: '/', icon: Home, label: 'Home' },
  { to: '/portfolio', icon: BarChart2, label: 'Portfolio' },
  { to: '/tax', icon: Receipt, label: 'Tax' },
  { to: '/watchlist', icon: Star, label: 'Watchlist' },
  { to: '/settings', icon: Settings, label: 'Settings' },
]

export default function BottomNav() {
  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-card border-t border-border flex justify-around py-2 z-50">
      {tabs.map(({ to, icon: Icon, label }) => (
        <NavLink
          key={to}
          to={to}
          end={to === '/'}
          className={({ isActive }) =>
            `flex flex-col items-center gap-1 px-4 py-1 text-xs ${
              isActive ? 'text-primary' : 'text-muted-foreground'
            }`
          }
        >
          <Icon size={20} />
          <span>{label}</span>
        </NavLink>
      ))}
    </nav>
  )
}
```

**Step 3: Install lucide-react**

```bash
npm install lucide-react
```

**Step 4: Create app layout**

```typescript
// src/layouts/AppLayout.tsx
import { Outlet } from 'react-router-dom'
import BottomNav from './BottomNav'

export default function AppLayout() {
  return (
    <div className="min-h-screen bg-background pb-16">
      <Outlet />
      <BottomNav />
    </div>
  )
}
```

**Step 5: Set up router**

```typescript
// src/router.tsx
import { createBrowserRouter } from 'react-router-dom'
import AppLayout from './layouts/AppLayout'
import Home from './pages/Home'
import Portfolio from './pages/Portfolio'
import Tax from './pages/Tax'
import Watchlist from './pages/Watchlist'
import Settings from './pages/Settings'

export const router = createBrowserRouter([
  {
    path: '/',
    element: <AppLayout />,
    children: [
      { index: true, element: <Home /> },
      { path: 'portfolio', element: <Portfolio /> },
      { path: 'tax', element: <Tax /> },
      { path: 'watchlist', element: <Watchlist /> },
      { path: 'settings', element: <Settings /> },
    ],
  },
])
```

**Step 6: Wire router into App.tsx**

```typescript
// src/App.tsx
import { RouterProvider } from 'react-router-dom'
import { router } from './router'

export default function App() {
  return <RouterProvider router={router} />
}
```

**Step 7: Write navigation test**

```typescript
// src/__tests__/BottomNav.test.tsx
import { render, screen } from '@testing-library/react'
import { MemoryRouter } from 'react-router-dom'
import BottomNav from '../layouts/BottomNav'

test('renders all nav tabs', () => {
  render(<MemoryRouter><BottomNav /></MemoryRouter>)
  expect(screen.getByText('Home')).toBeInTheDocument()
  expect(screen.getByText('Portfolio')).toBeInTheDocument()
  expect(screen.getByText('Tax')).toBeInTheDocument()
  expect(screen.getByText('Watchlist')).toBeInTheDocument()
  expect(screen.getByText('Settings')).toBeInTheDocument()
})
```

**Step 8: Run tests**

```bash
npm run test
```
Expected: PASS

**Step 9: Commit**

```bash
git add .
git commit -m "feat: add React Router app shell with bottom tab navigation"
```

---

## Phase 2: Supabase Setup

### Task 4: Create Supabase Project and Apply Schema

**Files:**
- Create: `supabase/migrations/20260220000001_initial_schema.sql`
- Create: `src/lib/supabase.ts`

**Step 1: Create a free Supabase project**

Go to https://supabase.com, create a project. Note your project URL and anon key.

**Step 2: Create the migration file**

```sql
-- supabase/migrations/20260220000001_initial_schema.sql

-- Tickers (stocks, ETFs tracked for price)
create table tickers (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  symbol text not null,
  current_price numeric(12,4),
  last_updated date,
  unique(user_id, symbol)
);

-- Themes (AI, Technology, etc.)
create table themes (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  name text not null,
  unique(user_id, name)
);

-- Ticker <-> Theme mapping
create table ticker_themes (
  ticker_id uuid references tickers on delete cascade,
  theme_id uuid references themes on delete cascade,
  primary key (ticker_id, theme_id)
);

-- Theme allocation targets
create table theme_targets (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  theme_id uuid references themes on delete cascade,
  target_percentage numeric(5,2) not null,
  is_active boolean default true
);

-- Assets (accounts/positions)
create table assets (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  name text not null,
  asset_type text not null,   -- 401k | CD | Cash | Deposit | HSA | Stock
  location_name text not null,
  account_type text not null, -- Investment | Checking | Savings | Misc
  ownership text not null,    -- Individual | Joint
  notes text,
  price numeric(12,4),        -- for non-stock assets
  ticker_id uuid references tickers
);

-- Stock subtypes per asset (Market / ESPP / RSU)
create table stock_subtypes (
  id uuid primary key default gen_random_uuid(),
  asset_id uuid references assets on delete cascade,
  subtype text not null  -- Market | ESPP | RSU
);

-- Individual tax lots (transactions)
create table transactions (
  id uuid primary key default gen_random_uuid(),
  subtype_id uuid references stock_subtypes on delete cascade,
  count numeric(12,6) not null,
  cost_price numeric(12,4) not null,
  purchase_date date not null,
  capital_gains_status text not null  -- Short Term | Long Term
);

-- RSU grants
create table rsu_grants (
  id uuid primary key default gen_random_uuid(),
  subtype_id uuid references stock_subtypes on delete cascade,
  grant_date date not null,
  first_vest_date date,
  cadence_months int,
  unvested_count int default 0
);

-- User settings
create table user_settings (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users unique not null,
  claude_api_key text,
  finnhub_api_key text,
  price_alert_threshold numeric(5,2) default 5.0,
  tax_harvest_threshold numeric(12,2) default 1000.0,
  rsu_alert_days_before int default 7
);

-- Push notification subscriptions
create table push_subscriptions (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users not null,
  endpoint text not null,
  p256dh text not null,
  auth text not null
);

-- Row Level Security
alter table tickers enable row level security;
alter table themes enable row level security;
alter table ticker_themes enable row level security;
alter table theme_targets enable row level security;
alter table assets enable row level security;
alter table stock_subtypes enable row level security;
alter table transactions enable row level security;
alter table rsu_grants enable row level security;
alter table user_settings enable row level security;
alter table push_subscriptions enable row level security;

-- RLS policies (user sees only their own data)
create policy "own data" on tickers for all using (auth.uid() = user_id);
create policy "own data" on themes for all using (auth.uid() = user_id);
create policy "own data via ticker" on ticker_themes for all
  using (exists (select 1 from tickers where tickers.id = ticker_id and tickers.user_id = auth.uid()));
create policy "own data" on theme_targets for all using (auth.uid() = user_id);
create policy "own data" on assets for all using (auth.uid() = user_id);
create policy "own data via asset" on stock_subtypes for all
  using (exists (select 1 from assets where assets.id = asset_id and assets.user_id = auth.uid()));
create policy "own data via subtype" on transactions for all
  using (exists (
    select 1 from stock_subtypes st
    join assets a on a.id = st.asset_id
    where st.id = subtype_id and a.user_id = auth.uid()
  ));
create policy "own data via subtype" on rsu_grants for all
  using (exists (
    select 1 from stock_subtypes st
    join assets a on a.id = st.asset_id
    where st.id = subtype_id and a.user_id = auth.uid()
  ));
create policy "own data" on user_settings for all using (auth.uid() = user_id);
create policy "own data" on push_subscriptions for all using (auth.uid() = user_id);
```

**Step 3: Apply migration via Supabase dashboard**

Go to Supabase Dashboard → SQL Editor → paste and run the migration SQL.

**Step 4: Create Supabase client**

```typescript
// src/lib/supabase.ts
import { createClient } from '@supabase/supabase-js'

// These are read from user settings (set during onboarding), not hardcoded
export function createSupabaseClient(url: string, anonKey: string) {
  return createClient(url, anonKey)
}

// Singleton after onboarding
let client: ReturnType<typeof createSupabaseClient> | null = null

export function getSupabaseClient() {
  if (!client) throw new Error('Supabase not configured. Complete onboarding first.')
  return client
}

export function initSupabase(url: string, anonKey: string) {
  client = createSupabaseClient(url, anonKey)
  return client
}
```

**Step 5: Commit**

```bash
git add .
git commit -m "feat: add Supabase schema migration and client setup"
```

---

### Task 5: Onboarding Flow

**Files:**
- Create: `src/pages/Onboarding.tsx`
- Create: `src/store/config.ts`
- Modify: `src/App.tsx`

**Step 1: Create config store using localStorage**

```typescript
// src/store/config.ts
const KEYS = {
  supabaseUrl: 'mne_supabase_url',
  supabaseAnonKey: 'mne_supabase_anon_key',
  claudeApiKey: 'mne_claude_api_key',
  finnhubApiKey: 'mne_finnhub_api_key',
}

export const config = {
  get supabaseUrl() { return localStorage.getItem(KEYS.supabaseUrl) ?? '' },
  get supabaseAnonKey() { return localStorage.getItem(KEYS.supabaseAnonKey) ?? '' },
  get claudeApiKey() { return localStorage.getItem(KEYS.claudeApiKey) ?? '' },
  get finnhubApiKey() { return localStorage.getItem(KEYS.finnhubApiKey) ?? '' },
  get isConfigured() {
    return !!(this.supabaseUrl && this.supabaseAnonKey && this.claudeApiKey && this.finnhubApiKey)
  },
  save(data: { supabaseUrl: string; supabaseAnonKey: string; claudeApiKey: string; finnhubApiKey: string }) {
    localStorage.setItem(KEYS.supabaseUrl, data.supabaseUrl)
    localStorage.setItem(KEYS.supabaseAnonKey, data.supabaseAnonKey)
    localStorage.setItem(KEYS.claudeApiKey, data.claudeApiKey)
    localStorage.setItem(KEYS.finnhubApiKey, data.finnhubApiKey)
  },
  clear() {
    Object.values(KEYS).forEach(k => localStorage.removeItem(k))
  }
}
```

**Step 2: Create onboarding page**

```typescript
// src/pages/Onboarding.tsx
import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'
import { config } from '@/store/config'
import { initSupabase } from '@/lib/supabase'

interface Props { onComplete: () => void }

export default function Onboarding({ onComplete }: Props) {
  const [step, setStep] = useState<'keys' | 'auth'>('keys')
  const [form, setForm] = useState({
    supabaseUrl: '', supabaseAnonKey: '', claudeApiKey: '', finnhubApiKey: '',
  })
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const [loading, setLoading] = useState(false)

  async function handleSaveKeys() {
    if (!form.supabaseUrl || !form.supabaseAnonKey || !form.claudeApiKey || !form.finnhubApiKey) {
      setError('All fields are required')
      return
    }
    config.save(form)
    initSupabase(form.supabaseUrl, form.supabaseAnonKey)
    setStep('auth')
    setError('')
  }

  async function handleAuth(mode: 'signin' | 'signup') {
    setLoading(true)
    setError('')
    const { getSupabaseClient } = await import('@/lib/supabase')
    const supabase = getSupabaseClient()
    const fn = mode === 'signup'
      ? supabase.auth.signUp({ email, password })
      : supabase.auth.signInWithPassword({ email, password })
    const { error } = await fn
    if (error) { setError(error.message); setLoading(false); return }
    onComplete()
  }

  if (step === 'keys') return (
    <div className="min-h-screen flex items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-2xl font-bold">Welcome to mne</CardTitle>
          <CardDescription>Connect your own accounts to get started.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {[
            { label: 'Supabase Project URL', key: 'supabaseUrl', placeholder: 'https://xxxx.supabase.co' },
            { label: 'Supabase Anon Key', key: 'supabaseAnonKey', placeholder: 'eyJ...' },
            { label: 'Claude API Key', key: 'claudeApiKey', placeholder: 'sk-ant-...' },
            { label: 'Finnhub API Key', key: 'finnhubApiKey', placeholder: 'your_key' },
          ].map(({ label, key, placeholder }) => (
            <div key={key} className="space-y-1">
              <Label>{label}</Label>
              <Input
                type="password"
                placeholder={placeholder}
                value={form[key as keyof typeof form]}
                onChange={e => setForm(f => ({ ...f, [key]: e.target.value }))}
              />
            </div>
          ))}
          {error && <p className="text-destructive text-sm">{error}</p>}
          <Button className="w-full" onClick={handleSaveKeys}>Continue</Button>
        </CardContent>
      </Card>
    </div>
  )

  return (
    <div className="min-h-screen flex items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle>Sign In</CardTitle>
          <CardDescription>Create or sign into your account.</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="space-y-1">
            <Label>Email</Label>
            <Input type="email" value={email} onChange={e => setEmail(e.target.value)} />
          </div>
          <div className="space-y-1">
            <Label>Password</Label>
            <Input type="password" value={password} onChange={e => setPassword(e.target.value)} />
          </div>
          {error && <p className="text-destructive text-sm">{error}</p>}
          <Button className="w-full" onClick={() => handleAuth('signin')} disabled={loading}>Sign In</Button>
          <Button variant="outline" className="w-full" onClick={() => handleAuth('signup')} disabled={loading}>Create Account</Button>
        </CardContent>
      </Card>
    </div>
  )
}
```

**Step 3: Add shadcn Input and Label**

```bash
npx shadcn@latest add input label
```

**Step 4: Gate App.tsx behind onboarding**

```typescript
// src/App.tsx
import { useState, useEffect } from 'react'
import { RouterProvider } from 'react-router-dom'
import { router } from './router'
import Onboarding from './pages/Onboarding'
import { config } from './store/config'
import { initSupabase } from './lib/supabase'

export default function App() {
  const [ready, setReady] = useState(false)

  useEffect(() => {
    if (config.isConfigured) {
      initSupabase(config.supabaseUrl, config.supabaseAnonKey)
      setReady(true)
    }
  }, [])

  if (!config.isConfigured || !ready) {
    return <Onboarding onComplete={() => setReady(true)} />
  }

  return <RouterProvider router={router} />
}
```

**Step 5: Write onboarding test**

```typescript
// src/__tests__/Onboarding.test.tsx
import { render, screen, fireEvent } from '@testing-library/react'
import Onboarding from '../pages/Onboarding'

test('shows all key fields', () => {
  render(<Onboarding onComplete={() => {}} />)
  expect(screen.getByText('Supabase Project URL')).toBeInTheDocument()
  expect(screen.getByText('Supabase Anon Key')).toBeInTheDocument()
  expect(screen.getByText('Claude API Key')).toBeInTheDocument()
  expect(screen.getByText('Finnhub API Key')).toBeInTheDocument()
})

test('shows error when fields are empty', async () => {
  render(<Onboarding onComplete={() => {}} />)
  fireEvent.click(screen.getByText('Continue'))
  expect(await screen.findByText('All fields are required')).toBeInTheDocument()
})
```

**Step 6: Run tests**

```bash
npm run test
```
Expected: PASS

**Step 7: Commit**

```bash
git add .
git commit -m "feat: add onboarding flow with API key collection and Supabase auth"
```

---

## Phase 3: Data Layer

### Task 6: Data Access Layer (Typed Supabase Queries)

**Files:**
- Create: `src/lib/db/assets.ts`
- Create: `src/lib/db/tickers.ts`
- Create: `src/lib/db/themes.ts`
- Create: `src/lib/db/settings.ts`
- Create: `src/lib/portfolio.ts` (computed values)

**Step 1: Generate TypeScript types from Supabase**

```bash
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > src/lib/database.types.ts
```

**Step 2: Create assets data access**

```typescript
// src/lib/db/assets.ts
import { getSupabaseClient } from '../supabase'

export async function getAllAssets() {
  const { data, error } = await getSupabaseClient()
    .from('assets')
    .select(`
      *,
      ticker:tickers(*),
      stock_subtypes(
        *,
        transactions(*),
        rsu_grants(*)
      )
    `)
    .order('name')
  if (error) throw error
  return data
}

export async function upsertAsset(asset: Record<string, unknown>) {
  const { data, error } = await getSupabaseClient()
    .from('assets')
    .upsert(asset)
    .select()
    .single()
  if (error) throw error
  return data
}

export async function deleteAsset(id: string) {
  const { error } = await getSupabaseClient().from('assets').delete().eq('id', id)
  if (error) throw error
}
```

**Step 3: Create tickers data access**

```typescript
// src/lib/db/tickers.ts
import { getSupabaseClient } from '../supabase'

export async function getAllTickers() {
  const { data, error } = await getSupabaseClient()
    .from('tickers')
    .select('*, ticker_themes(theme:themes(*))')
    .order('symbol')
  if (error) throw error
  return data
}

export async function updateTickerPrice(symbol: string, price: number) {
  const { error } = await getSupabaseClient()
    .from('tickers')
    .update({ current_price: price, last_updated: new Date().toISOString().split('T')[0] })
    .eq('symbol', symbol)
  if (error) throw error
}
```

**Step 4: Create portfolio computation helpers**

```typescript
// src/lib/portfolio.ts

export type Asset = Awaited<ReturnType<typeof import('./db/assets').getAllAssets>>[number]

export function computeAssetValue(asset: Asset): number {
  if (asset.asset_type !== 'Stock') return asset.price ?? 0
  if (!asset.ticker?.current_price) return 0
  const price = asset.ticker.current_price
  const shares = asset.stock_subtypes?.flatMap(st => st.transactions ?? [])
    .reduce((sum, t) => sum + Number(t.count), 0) ?? 0
  return price * shares
}

export function computeCostBasis(asset: Asset): number {
  return asset.stock_subtypes?.flatMap(st => st.transactions ?? [])
    .reduce((sum, t) => sum + Number(t.count) * Number(t.cost_price), 0) ?? 0
}

export function computeUnrealizedGain(asset: Asset): number {
  return computeAssetValue(asset) - computeCostBasis(asset)
}

export function computeTotalNetWorth(assets: Asset[]): number {
  return assets.reduce((sum, a) => sum + computeAssetValue(a), 0)
}
```

**Step 5: Write portfolio computation tests**

```typescript
// src/__tests__/portfolio.test.ts
import { computeAssetValue, computeCostBasis, computeUnrealizedGain, computeTotalNetWorth } from '../lib/portfolio'

const mockStockAsset = {
  asset_type: 'Stock',
  price: null,
  ticker: { current_price: 100 },
  stock_subtypes: [{
    transactions: [
      { count: '10', cost_price: '80' },
      { count: '5', cost_price: '90' },
    ],
    rsu_grants: []
  }]
} as any

const mockCashAsset = {
  asset_type: 'Cash',
  price: 5000,
  ticker: null,
  stock_subtypes: []
} as any

test('computes stock value from shares * current price', () => {
  expect(computeAssetValue(mockStockAsset)).toBe(1500) // 15 shares * $100
})

test('computes cost basis from lots', () => {
  expect(computeCostBasis(mockStockAsset)).toBe(1250) // (10*80) + (5*90)
})

test('computes unrealized gain', () => {
  expect(computeUnrealizedGain(mockStockAsset)).toBe(250) // 1500 - 1250
})

test('computes total net worth', () => {
  expect(computeTotalNetWorth([mockStockAsset, mockCashAsset])).toBe(6500)
})
```

**Step 6: Run tests**

```bash
npm run test
```
Expected: PASS

**Step 7: Commit**

```bash
git add .
git commit -m "feat: add typed data access layer and portfolio computation helpers"
```

---

## Phase 4: Core Screens

### Task 7: Home Screen

**Files:**
- Modify: `src/pages/Home.tsx`
- Create: `src/components/NetWorthCard.tsx`
- Create: `src/components/AssetTypeBreakdown.tsx`
- Create: `src/components/ThemeBreakdown.tsx`

**Step 1: Create NetWorthCard component**

```typescript
// src/components/NetWorthCard.tsx
interface Props { value: number; gainLoss: number; gainLossPercent: number }

export function NetWorthCard({ value, gainLoss, gainLossPercent }: Props) {
  const isGain = gainLoss >= 0
  return (
    <div className="px-6 pt-12 pb-6">
      {/* Radial glow effect */}
      <div className="absolute inset-0 flex items-start justify-center pt-8 pointer-events-none">
        <div className="w-64 h-32 bg-primary/10 rounded-full blur-3xl" />
      </div>
      <p className="text-muted-foreground text-sm uppercase tracking-widest mb-2">Net Worth</p>
      <p className="text-5xl font-bold text-foreground">
        {formatCurrency(value)}
      </p>
      <p className={`mt-2 text-lg font-medium ${isGain ? 'text-gain' : 'text-loss'}`}>
        {isGain ? '+' : ''}{formatCurrency(gainLoss)} ({isGain ? '+' : ''}{gainLossPercent.toFixed(2)}%)
      </p>
    </div>
  )
}

function formatCurrency(n: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n)
}
```

**Step 2: Create AssetTypeBreakdown component (expandable card)**

```typescript
// src/components/AssetTypeBreakdown.tsx
import { useState } from 'react'
import { ChevronDown, ChevronUp } from 'lucide-react'
import { Card, CardContent } from '@/components/ui/card'

interface AssetGroup { type: string; value: number; count: number }
interface Props { groups: AssetGroup[]; totalValue: number }

export function AssetTypeBreakdown({ groups, totalValue }: Props) {
  const [expanded, setExpanded] = useState(false)

  return (
    <Card className="mx-4 mb-3">
      <CardContent className="p-4">
        <button
          className="w-full flex justify-between items-center"
          onClick={() => setExpanded(e => !e)}
        >
          <span className="font-medium">By Asset Type</span>
          {expanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </button>
        {expanded && (
          <div className="mt-3 space-y-2">
            {groups.map(g => (
              <div key={g.type} className="flex justify-between items-center">
                <span className="text-muted-foreground text-sm">{g.type}</span>
                <div className="text-right">
                  <span className="font-medium">{formatCurrency(g.value)}</span>
                  <span className="text-muted-foreground text-xs ml-2">
                    {((g.value / totalValue) * 100).toFixed(1)}%
                  </span>
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}

function formatCurrency(n: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n)
}
```

**Step 3: Wire Home screen**

```typescript
// src/pages/Home.tsx
import { useEffect, useState } from 'react'
import { getAllAssets } from '@/lib/db/assets'
import { computeAssetValue, computeCostBasis, computeTotalNetWorth } from '@/lib/portfolio'
import { NetWorthCard } from '@/components/NetWorthCard'
import { AssetTypeBreakdown } from '@/components/AssetTypeBreakdown'

export default function Home() {
  const [assets, setAssets] = useState<any[]>([])

  useEffect(() => {
    getAllAssets().then(setAssets).catch(console.error)
  }, [])

  const totalValue = computeTotalNetWorth(assets)
  const totalCost = assets.reduce((sum, a) => sum + computeCostBasis(a), 0)
  const gainLoss = totalValue - totalCost
  const gainLossPercent = totalCost > 0 ? (gainLoss / totalCost) * 100 : 0

  const groups = groupByAssetType(assets)

  return (
    <div className="relative">
      <NetWorthCard value={totalValue} gainLoss={gainLoss} gainLossPercent={gainLossPercent} />
      <AssetTypeBreakdown groups={groups} totalValue={totalValue} />
      {/* ThemeBreakdown and OwnershipBreakdown follow same pattern */}
    </div>
  )
}

function groupByAssetType(assets: any[]) {
  const map: Record<string, { value: number; count: number }> = {}
  for (const a of assets) {
    const val = computeAssetValue(a)
    if (!map[a.asset_type]) map[a.asset_type] = { value: 0, count: 0 }
    map[a.asset_type].value += val
    map[a.asset_type].count += 1
  }
  return Object.entries(map).map(([type, { value, count }]) => ({ type, value, count }))
}
```

**Step 4: Write Home screen test**

```typescript
// src/__tests__/Home.test.tsx
import { render, screen } from '@testing-library/react'
import { NetWorthCard } from '../components/NetWorthCard'

test('displays net worth with gain', () => {
  render(<NetWorthCard value={100000} gainLoss={5000} gainLossPercent={5.26} />)
  expect(screen.getByText('Net Worth')).toBeInTheDocument()
  expect(screen.getByText(/100,000/)).toBeInTheDocument()
  expect(screen.getByText(/\+5,000/)).toBeInTheDocument()
})
```

**Step 5: Run tests + commit**

```bash
npm run test
git add .
git commit -m "feat: implement Home screen with net worth headline and expandable breakdowns"
```

---

### Task 8: Portfolio Screen

**Files:**
- Modify: `src/pages/Portfolio.tsx`
- Create: `src/components/PositionCard.tsx`
- Create: `src/components/TaxLotList.tsx`

**Step 1: Create PositionCard**

```typescript
// src/components/PositionCard.tsx
import { useState } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { ChevronDown, ChevronUp } from 'lucide-react'
import { TaxLotList } from './TaxLotList'
import { computeAssetValue, computeCostBasis, computeUnrealizedGain } from '@/lib/portfolio'

export function PositionCard({ asset }: { asset: any }) {
  const [expanded, setExpanded] = useState(false)
  const value = computeAssetValue(asset)
  const gain = computeUnrealizedGain(asset)
  const gainPct = computeCostBasis(asset) > 0 ? (gain / computeCostBasis(asset)) * 100 : 0
  const isGain = gain >= 0

  return (
    <Card className="mx-4 mb-2">
      <CardContent className="p-4">
        <button className="w-full" onClick={() => setExpanded(e => !e)}>
          <div className="flex justify-between items-start">
            <div className="text-left">
              <p className="font-medium">{asset.name}</p>
              <p className="text-muted-foreground text-xs">{asset.location_name} · {asset.asset_type}</p>
            </div>
            <div className="text-right">
              <p className="font-medium">{fmt(value)}</p>
              <p className={`text-sm ${isGain ? 'text-gain' : 'text-loss'}`}>
                {isGain ? '+' : ''}{fmt(gain)} ({gainPct.toFixed(1)}%)
              </p>
            </div>
          </div>
        </button>
        {expanded && asset.stock_subtypes?.length > 0 && (
          <TaxLotList subtypes={asset.stock_subtypes} ticker={asset.ticker} />
        )}
        {expanded && asset.notes && (
          <p className="mt-2 text-muted-foreground text-xs border-t border-border pt-2">{asset.notes}</p>
        )}
      </CardContent>
    </Card>
  )
}

function fmt(n: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n)
}
```

**Step 2: Create TaxLotList**

```typescript
// src/components/TaxLotList.tsx
import { Badge } from '@/components/ui/badge'

export function TaxLotList({ subtypes, ticker }: { subtypes: any[]; ticker: any }) {
  return (
    <div className="mt-3 border-t border-border pt-3 space-y-4">
      {subtypes.map((st: any) => (
        <div key={st.id}>
          <p className="text-xs font-semibold text-muted-foreground uppercase tracking-wide mb-2">{st.subtype}</p>
          {st.transactions?.map((t: any) => {
            const currentValue = Number(t.count) * (ticker?.current_price ?? 0)
            const costBasis = Number(t.count) * Number(t.cost_price)
            const gain = currentValue - costBasis
            return (
              <div key={t.id} className="flex justify-between text-sm mb-1">
                <div>
                  <span>{Number(t.count).toFixed(2)} shares @ {fmt(t.cost_price)}</span>
                  <Badge
                    variant={t.capital_gains_status === 'Long Term' ? 'secondary' : 'outline'}
                    className="ml-2 text-xs"
                  >
                    {t.capital_gains_status}
                  </Badge>
                </div>
                <span className={gain >= 0 ? 'text-gain' : 'text-loss'}>
                  {gain >= 0 ? '+' : ''}{fmt(gain)}
                </span>
              </div>
            )
          })}
          {st.rsu_grants?.map((g: any) => (
            <div key={g.id} className="text-sm text-muted-foreground">
              RSU Grant {g.grant_date}: {g.unvested_count} unvested shares
            </div>
          ))}
        </div>
      ))}
    </div>
  )
}

function fmt(n: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(Number(n))
}
```

**Step 3: Wire Portfolio page**

```typescript
// src/pages/Portfolio.tsx
import { useEffect, useState } from 'react'
import { getAllAssets } from '@/lib/db/assets'
import { PositionCard } from '@/components/PositionCard'

export default function Portfolio() {
  const [assets, setAssets] = useState<any[]>([])

  useEffect(() => {
    getAllAssets().then(setAssets).catch(console.error)
  }, [])

  return (
    <div className="pt-6 pb-4">
      <h1 className="text-xl font-bold px-4 mb-4">Portfolio</h1>
      {assets.map(a => <PositionCard key={a.id} asset={a} />)}
      {assets.length === 0 && (
        <p className="text-muted-foreground text-center mt-16">
          No positions yet. Use ⌘K to add one.
        </p>
      )}
    </div>
  )
}
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: implement Portfolio screen with expandable position and tax lot cards"
```

---

### Task 9: Tax Screen

**Files:**
- Modify: `src/pages/Tax.tsx`

**Step 1: Implement Tax page**

```typescript
// src/pages/Tax.tsx
import { useEffect, useState } from 'react'
import { getAllAssets } from '@/lib/db/assets'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'

export default function Tax() {
  const [assets, setAssets] = useState<any[]>([])

  useEffect(() => { getAllAssets().then(setAssets) }, [])

  const allLots = assets.flatMap(a =>
    (a.stock_subtypes ?? []).flatMap((st: any) =>
      (st.transactions ?? []).map((t: any) => ({
        ...t,
        assetName: a.name,
        ticker: a.ticker,
      }))
    )
  )

  const shortTerm = allLots.filter(t => t.capital_gains_status === 'Short Term')
  const longTerm = allLots.filter(t => t.capital_gains_status === 'Long Term')

  function lotGain(t: any) {
    return Number(t.count) * ((t.ticker?.current_price ?? 0) - Number(t.cost_price))
  }

  const shortGain = shortTerm.reduce((s, t) => s + lotGain(t), 0)
  const longGain = longTerm.reduce((s, t) => s + lotGain(t), 0)

  const harvestCandidates = allLots.filter(t => lotGain(t) < -1000)

  return (
    <div className="pt-6 pb-4 px-4 space-y-4">
      <h1 className="text-xl font-bold">Tax</h1>
      <div className="grid grid-cols-2 gap-3">
        <Card>
          <CardHeader className="pb-1"><CardTitle className="text-sm text-muted-foreground">Short-Term Gains</CardTitle></CardHeader>
          <CardContent><p className={`text-xl font-bold ${shortGain >= 0 ? 'text-gain' : 'text-loss'}`}>{fmt(shortGain)}</p></CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-1"><CardTitle className="text-sm text-muted-foreground">Long-Term Gains</CardTitle></CardHeader>
          <CardContent><p className={`text-xl font-bold ${longGain >= 0 ? 'text-gain' : 'text-loss'}`}>{fmt(longGain)}</p></CardContent>
        </Card>
      </div>
      {harvestCandidates.length > 0 && (
        <Card>
          <CardHeader><CardTitle className="text-sm">Tax Loss Harvest Candidates</CardTitle></CardHeader>
          <CardContent className="space-y-2">
            {harvestCandidates.map(t => (
              <div key={t.id} className="flex justify-between text-sm">
                <span>{t.assetName}</span>
                <span className="text-loss">{fmt(lotGain(t))}</span>
              </div>
            ))}
          </CardContent>
        </Card>
      )}
    </div>
  )
}

function fmt(n: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n)
}
```

**Step 2: Commit**

```bash
git add .
git commit -m "feat: implement Tax screen with gains summary and harvest candidates"
```

---

### Task 10: Watchlist and Settings Screens

**Files:**
- Modify: `src/pages/Watchlist.tsx`
- Modify: `src/pages/Settings.tsx`
- Create: `src/lib/db/settings.ts`

**Step 1: Create settings data access**

```typescript
// src/lib/db/settings.ts
import { getSupabaseClient } from '../supabase'

export async function getSettings() {
  const { data: { user } } = await getSupabaseClient().auth.getUser()
  if (!user) throw new Error('Not authenticated')
  const { data, error } = await getSupabaseClient()
    .from('user_settings')
    .select('*')
    .eq('user_id', user.id)
    .single()
  if (error && error.code !== 'PGRST116') throw error
  return data
}

export async function saveSettings(settings: Record<string, unknown>) {
  const { data: { user } } = await getSupabaseClient().auth.getUser()
  if (!user) throw new Error('Not authenticated')
  const { error } = await getSupabaseClient()
    .from('user_settings')
    .upsert({ ...settings, user_id: user.id })
  if (error) throw error
}
```

**Step 2: Implement Watchlist page**

```typescript
// src/pages/Watchlist.tsx
import { useEffect, useState } from 'react'
import { getAllTickers } from '@/lib/db/tickers'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'

export default function Watchlist() {
  const [tickers, setTickers] = useState<any[]>([])

  useEffect(() => { getAllTickers().then(setTickers) }, [])

  return (
    <div className="pt-6 pb-4">
      <h1 className="text-xl font-bold px-4 mb-4">Watchlist</h1>
      {tickers.map(t => (
        <Card key={t.id} className="mx-4 mb-2">
          <CardContent className="p-4 flex justify-between items-center">
            <div>
              <p className="font-medium">{t.symbol}</p>
              <div className="flex gap-1 mt-1 flex-wrap">
                {t.ticker_themes?.map((tt: any) => (
                  <Badge key={tt.theme.id} variant="secondary" className="text-xs">{tt.theme.name}</Badge>
                ))}
              </div>
            </div>
            <p className="font-medium">${Number(t.current_price).toFixed(2)}</p>
          </CardContent>
        </Card>
      ))}
    </div>
  )
}
```

**Step 3: Implement Settings page**

```typescript
// src/pages/Settings.tsx
import { useEffect, useState } from 'react'
import { getSettings, saveSettings } from '@/lib/db/settings'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Button } from '@/components/ui/button'
import { config } from '@/store/config'
import { exportData, importData } from '@/lib/importExport'

export default function Settings() {
  const [settings, setSettings] = useState({
    price_alert_threshold: 5,
    tax_harvest_threshold: 1000,
    rsu_alert_days_before: 7,
  })

  useEffect(() => {
    getSettings().then(s => { if (s) setSettings(s as any) }).catch(console.error)
  }, [])

  async function handleSave() {
    await saveSettings(settings)
    alert('Saved')
  }

  return (
    <div className="pt-6 pb-4 px-4 space-y-4">
      <h1 className="text-xl font-bold">Settings</h1>

      <Card>
        <CardHeader><CardTitle className="text-sm">Notifications</CardTitle></CardHeader>
        <CardContent className="space-y-3">
          <div className="space-y-1">
            <Label>Price alert threshold (%)</Label>
            <Input type="number" value={settings.price_alert_threshold}
              onChange={e => setSettings(s => ({ ...s, price_alert_threshold: Number(e.target.value) }))} />
          </div>
          <div className="space-y-1">
            <Label>Tax harvest threshold ($)</Label>
            <Input type="number" value={settings.tax_harvest_threshold}
              onChange={e => setSettings(s => ({ ...s, tax_harvest_threshold: Number(e.target.value) }))} />
          </div>
          <div className="space-y-1">
            <Label>RSU vest reminder (days before)</Label>
            <Input type="number" value={settings.rsu_alert_days_before}
              onChange={e => setSettings(s => ({ ...s, rsu_alert_days_before: Number(e.target.value) }))} />
          </div>
          <Button onClick={handleSave} className="w-full">Save</Button>
        </CardContent>
      </Card>

      <Card>
        <CardHeader><CardTitle className="text-sm">Data</CardTitle></CardHeader>
        <CardContent className="space-y-2">
          <Button variant="outline" className="w-full" onClick={exportData}>Export JSON</Button>
          <Button variant="outline" className="w-full" onClick={() => document.getElementById('import-file')?.click()}>
            Import JSON
          </Button>
          <input id="import-file" type="file" accept=".json" className="hidden"
            onChange={e => { const f = e.target.files?.[0]; if (f) importData(f) }} />
        </CardContent>
      </Card>

      <Card>
        <CardHeader><CardTitle className="text-sm">API Keys</CardTitle></CardHeader>
        <CardContent>
          <p className="text-muted-foreground text-sm">Claude: {config.claudeApiKey ? '••••••' : 'Not set'}</p>
          <p className="text-muted-foreground text-sm">Finnhub: {config.finnhubApiKey ? '••••••' : 'Not set'}</p>
          <Button variant="outline" className="w-full mt-3" onClick={() => { config.clear(); window.location.reload() }}>
            Reset & Re-configure
          </Button>
        </CardContent>
      </Card>
    </div>
  )
}
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: implement Watchlist and Settings screens"
```

---

## Phase 5: Import / Export

### Task 11: JSON Import and Export

**Files:**
- Create: `src/lib/importExport.ts`

**Step 1: Write failing tests**

```typescript
// src/__tests__/importExport.test.ts
import { serializeForExport, parseImport } from '../lib/importExport'

test('serializes assets to export format', () => {
  const data = { assets: [{ id: '1', name: 'Cash', asset_type: 'Cash' }], tickers: [], themes: [] }
  const result = serializeForExport(data)
  expect(result.assets).toHaveLength(1)
  expect(result.version).toBe('1.0')
  expect(result.exportDate).toBeDefined()
})

test('parses valid import JSON', () => {
  const raw = JSON.stringify({ assets: [], tickers: [], themes: [], version: '1.0' })
  const result = parseImport(raw)
  expect(result.assets).toEqual([])
})

test('throws on invalid import JSON', () => {
  expect(() => parseImport('not json')).toThrow()
})
```

**Step 2: Run to verify failure**

```bash
npm run test src/__tests__/importExport.test.ts
```
Expected: FAIL (module not found)

**Step 3: Implement import/export**

```typescript
// src/lib/importExport.ts
import { getSupabaseClient } from './supabase'
import { getAllAssets } from './db/assets'
import { getAllTickers } from './db/tickers'

export function serializeForExport(data: { assets: any[]; tickers: any[]; themes: any[] }) {
  return {
    ...data,
    version: '1.0',
    exportDate: new Date().toISOString().split('T')[0],
  }
}

export function parseImport(raw: string) {
  const data = JSON.parse(raw)  // throws on invalid JSON
  if (!data.assets || !Array.isArray(data.assets)) throw new Error('Invalid format: missing assets')
  return data
}

export async function exportData() {
  const [assets, tickers] = await Promise.all([getAllAssets(), getAllTickers()])
  const payload = serializeForExport({ assets, tickers, themes: [] })
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `mne-export-${new Date().toISOString().split('T')[0]}.json`
  a.click()
  URL.revokeObjectURL(url)
}

export async function importData(file: File) {
  const raw = await file.text()
  const data = parseImport(raw)
  // TODO: bulk insert assets, tickers, themes into Supabase with confirmation step
  console.log('Parsed import data:', data)
  alert(`Ready to import ${data.assets.length} assets. Bulk import coming in next step.`)
}
```

**Step 4: Run tests**

```bash
npm run test src/__tests__/importExport.test.ts
```
Expected: PASS

**Step 5: Commit**

```bash
git add .
git commit -m "feat: add JSON import and export with Moola-compatible format"
```

---

## Phase 6: Command Bar (Claude Integration)

### Task 12: Command Bar UI

**Files:**
- Create: `src/components/CommandBar.tsx`
- Modify: `src/layouts/AppLayout.tsx`

**Step 1: Install cmdk**

```bash
npm install cmdk
```

**Step 2: Create CommandBar component**

```typescript
// src/components/CommandBar.tsx
import { useState, useEffect } from 'react'
import { Dialog, DialogContent } from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { runCommand } from '@/lib/claude'

export function CommandBar() {
  const [open, setOpen] = useState(false)
  const [query, setQuery] = useState('')
  const [result, setResult] = useState<{ type: string; message: string } | null>(null)
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    const handler = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault()
        setOpen(o => !o)
        setQuery('')
        setResult(null)
      }
    }
    document.addEventListener('keydown', handler)
    return () => document.removeEventListener('keydown', handler)
  }, [])

  async function handleSubmit() {
    if (!query.trim()) return
    setLoading(true)
    try {
      const action = await runCommand(query)
      setResult(action)
    } catch (e: any) {
      setResult({ type: 'error', message: e.message })
    } finally {
      setLoading(false)
    }
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogContent className="p-0 gap-0 max-w-lg">
        <div className="flex items-center border-b border-border px-4 py-3">
          <Input
            autoFocus
            placeholder="Ask anything or issue a command..."
            value={query}
            onChange={e => setQuery(e.target.value)}
            onKeyDown={e => e.key === 'Enter' && handleSubmit()}
            className="border-0 focus-visible:ring-0 text-base"
          />
        </div>
        {loading && <p className="p-4 text-muted-foreground text-sm">Thinking...</p>}
        {result && !loading && (
          <CommandResult action={result} onClose={() => setOpen(false)} />
        )}
        {!result && !loading && (
          <p className="p-4 text-muted-foreground text-xs">
            Try: "What's my AI theme total?" or "Add 10 AAPL shares at $220 bought today"
          </p>
        )}
      </DialogContent>
    </Dialog>
  )
}

function CommandResult({ action, onClose }: { action: any; onClose: () => void }) {
  if (action.type === 'navigate') {
    // Navigation is handled in claude.ts before returning
    return <p className="p-4 text-sm text-gain">Navigating to {action.route}...</p>
  }
  if (action.type === 'write_confirm') {
    return (
      <div className="p-4 space-y-3">
        <p className="text-sm">{action.confirmationMessage}</p>
        <div className="flex gap-2">
          <button
            className="flex-1 bg-primary text-primary-foreground rounded-md py-2 text-sm font-medium"
            onClick={() => { action.execute(); onClose() }}
          >
            Confirm
          </button>
          <button
            className="flex-1 border border-border rounded-md py-2 text-sm"
            onClick={onClose}
          >
            Cancel
          </button>
        </div>
      </div>
    )
  }
  return <p className="p-4 text-sm text-destructive">{action.message}</p>
}
```

**Step 3: Add CommandBar to AppLayout**

```typescript
// In AppLayout.tsx, add <CommandBar /> alongside <Outlet />
import { CommandBar } from '@/components/CommandBar'

export default function AppLayout() {
  return (
    <div className="min-h-screen bg-background pb-16">
      <CommandBar />
      <Outlet />
      <BottomNav />
    </div>
  )
}
```

**Step 4: Commit**

```bash
git add .
git commit -m "feat: add command bar UI with ⌘K trigger and result display"
```

---

### Task 13: Claude Integration

**Files:**
- Create: `src/lib/claude.ts`

**Step 1: Write failing test**

```typescript
// src/__tests__/claude.test.ts
import { buildSystemPrompt } from '../lib/claude'

test('system prompt includes portfolio context instruction', () => {
  const prompt = buildSystemPrompt([])
  expect(prompt).toContain('portfolio')
  expect(prompt).toContain('JSON')
})
```

**Step 2: Implement Claude integration**

```typescript
// src/lib/claude.ts
import Anthropic from '@anthropic-ai/sdk'
import { config } from '@/store/config'
import { getAllAssets } from './db/assets'
import { getAllTickers } from './db/tickers'
import { upsertAsset } from './db/assets'
import { updateTickerPrice } from './db/tickers'

export function buildSystemPrompt(assets: any[]): string {
  return `You are a portfolio assistant for a personal finance app.
The user will issue read or write commands in natural language.

Current portfolio data (JSON):
${JSON.stringify(assets, null, 2)}

Respond ONLY with a JSON object in one of these shapes:

For READ commands (navigate to a view):
{ "type": "navigate", "route": "/portfolio" | "/tax" | "/watchlist" | "/settings", "filter": "optional filter string" }

For WRITE commands (data changes — always require confirmation):
{ "type": "write_confirm", "confirmationMessage": "Human-readable summary of the change", "writes": [{ "table": "string", "operation": "upsert"|"delete", "data": {} }] }

For errors or ambiguous commands:
{ "type": "error", "message": "explanation" }

Rules:
- ALL write commands must use type "write_confirm", never auto-commit
- Be specific in confirmationMessage (include names, amounts, dates)
- For stock transactions, include capital_gains_status based on whether purchase_date is within 1 year
- Today's date is ${new Date().toISOString().split('T')[0]}`
}

export async function runCommand(query: string): Promise<any> {
  const [assets, tickers] = await Promise.all([getAllAssets(), getAllTickers()])
  const client = new Anthropic({ apiKey: config.claudeApiKey, dangerouslyAllowBrowser: true })

  const response = await client.messages.create({
    model: 'claude-sonnet-4-6',
    max_tokens: 1024,
    system: buildSystemPrompt(assets),
    messages: [{ role: 'user', content: query }],
  })

  const text = response.content[0].type === 'text' ? response.content[0].text : ''
  const action = JSON.parse(text)

  if (action.type === 'navigate') {
    window.location.href = action.route + (action.filter ? `?filter=${action.filter}` : '')
  }

  if (action.type === 'write_confirm') {
    action.execute = async () => {
      const supabase = (await import('./supabase')).getSupabaseClient()
      for (const w of action.writes) {
        if (w.operation === 'upsert') {
          await supabase.from(w.table).upsert(w.data)
        } else if (w.operation === 'delete') {
          await supabase.from(w.table).delete().eq('id', w.data.id)
        }
      }
    }
  }

  return action
}
```

**Step 3: Run tests**

```bash
npm run test
```
Expected: PASS

**Step 4: Commit**

```bash
git add .
git commit -m "feat: integrate Claude API for natural language command bar"
```

---

## Phase 7: Push Notifications

### Task 14: Web Push Setup + VAPID

**Files:**
- Create: `supabase/functions/send-push/index.ts`
- Create: `supabase/functions/check-prices/index.ts`
- Create: `supabase/functions/check-vests/index.ts`
- Create: `src/lib/pushNotifications.ts`

**Step 1: Generate VAPID keys**

```bash
npx web-push generate-vapid-keys
```
Copy the public and private keys. Add them to Supabase project secrets:
- `VAPID_PUBLIC_KEY`
- `VAPID_PRIVATE_KEY`
- `VAPID_SUBJECT` (e.g. `mailto:you@example.com`)

**Step 2: Add public VAPID key to app config**

Add `VITE_VAPID_PUBLIC_KEY=<your_public_key>` to `.env.local`.

**Step 3: Create push subscription helper**

```typescript
// src/lib/pushNotifications.ts
import { getSupabaseClient } from './supabase'

export async function subscribeToPush() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    throw new Error('Push notifications not supported on this browser')
  }

  const permission = await Notification.requestPermission()
  if (permission !== 'granted') throw new Error('Notification permission denied')

  const reg = await navigator.serviceWorker.ready
  const sub = await reg.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(import.meta.env.VITE_VAPID_PUBLIC_KEY),
  })

  const json = sub.toJSON()
  const supabase = getSupabaseClient()
  const { data: { user } } = await supabase.auth.getUser()

  await supabase.from('push_subscriptions').upsert({
    user_id: user!.id,
    endpoint: json.endpoint,
    p256dh: (json.keys as any).p256dh,
    auth: (json.keys as any).auth,
  })
}

function urlBase64ToUint8Array(base64String: string) {
  const padding = '='.repeat((4 - (base64String.length % 4)) % 4)
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/')
  const rawData = atob(base64)
  return new Uint8Array([...rawData].map(c => c.charCodeAt(0)))
}
```

**Step 4: Create send-push Edge Function**

```typescript
// supabase/functions/send-push/index.ts
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
import webpush from 'npm:web-push'

Deno.serve(async (req) => {
  const { user_id, title, body } = await req.json()

  webpush.setVapidDetails(
    Deno.env.get('VAPID_SUBJECT')!,
    Deno.env.get('VAPID_PUBLIC_KEY')!,
    Deno.env.get('VAPID_PRIVATE_KEY')!,
  )

  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
  )

  const { data: subs } = await supabase
    .from('push_subscriptions')
    .select('*')
    .eq('user_id', user_id)

  const results = await Promise.allSettled(
    (subs ?? []).map(sub =>
      webpush.sendNotification(
        { endpoint: sub.endpoint, keys: { p256dh: sub.p256dh, auth: sub.auth } },
        JSON.stringify({ title, body })
      )
    )
  )

  return new Response(JSON.stringify({ sent: results.filter(r => r.status === 'fulfilled').length }))
})
```

**Step 5: Create check-prices Edge Function**

```typescript
// supabase/functions/check-prices/index.ts
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

Deno.serve(async () => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
  )

  const { data: settings } = await supabase.from('user_settings').select('*')

  for (const userSettings of settings ?? []) {
    const { data: tickers } = await supabase
      .from('tickers')
      .select('*')
      .eq('user_id', userSettings.user_id)
      .not('current_price', 'is', null)

    for (const ticker of tickers ?? []) {
      const res = await fetch(
        `https://finnhub.io/api/v1/quote?symbol=${ticker.symbol}&token=${userSettings.finnhub_api_key}`
      )
      const quote = await res.json()
      const newPrice = quote.c
      if (!newPrice) continue

      const oldPrice = Number(ticker.current_price)
      const changePct = Math.abs((newPrice - oldPrice) / oldPrice * 100)

      if (changePct >= Number(userSettings.price_alert_threshold)) {
        const direction = newPrice > oldPrice ? '▲' : '▼'
        await fetch(`${Deno.env.get('SUPABASE_URL')}/functions/v1/send-push`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${Deno.env.get('SUPABASE_ANON_KEY')}`,
          },
          body: JSON.stringify({
            user_id: userSettings.user_id,
            title: `${ticker.symbol} moved ${direction}${changePct.toFixed(1)}%`,
            body: `$${oldPrice.toFixed(2)} → $${newPrice.toFixed(2)}`,
          }),
        })
      }

      await supabase.from('tickers')
        .update({ current_price: newPrice, last_updated: new Date().toISOString().split('T')[0] })
        .eq('id', ticker.id)
    }
  }

  return new Response(JSON.stringify({ ok: true }))
})
```

**Step 6: Create check-vests Edge Function**

```typescript
// supabase/functions/check-vests/index.ts
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

Deno.serve(async () => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!,
  )

  const { data: settings } = await supabase.from('user_settings').select('*')

  for (const userSettings of settings ?? []) {
    const daysAhead = userSettings.rsu_alert_days_before ?? 7
    const cutoff = new Date()
    cutoff.setDate(cutoff.getDate() + daysAhead)

    // Find RSU grants with unvested shares vesting within the threshold
    const { data: grants } = await supabase
      .from('rsu_grants')
      .select(`
        *,
        stock_subtypes!inner(
          asset:assets!inner(user_id, name)
        )
      `)
      .eq('stock_subtypes.asset.user_id', userSettings.user_id)
      .gt('unvested_count', 0)

    for (const grant of grants ?? []) {
      // Compute next vest date from first_vest_date + cadence
      const nextVest = computeNextVestDate(grant)
      if (!nextVest) continue
      if (nextVest <= cutoff && nextVest >= new Date()) {
        await fetch(`${Deno.env.get('SUPABASE_URL')}/functions/v1/send-push`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${Deno.env.get('SUPABASE_ANON_KEY')}`,
          },
          body: JSON.stringify({
            user_id: userSettings.user_id,
            title: `RSU Vesting Soon`,
            body: `${grant.stock_subtypes.asset.name}: ${grant.unvested_count} shares vest on ${nextVest.toDateString()}`,
          }),
        })
      }
    }
  }

  return new Response(JSON.stringify({ ok: true }))
})

function computeNextVestDate(grant: any): Date | null {
  if (!grant.first_vest_date || !grant.cadence_months) return null
  const first = new Date(grant.first_vest_date)
  const now = new Date()
  let vest = new Date(first)
  while (vest < now) {
    vest.setMonth(vest.getMonth() + grant.cadence_months)
  }
  return vest
}
```

**Step 7: Schedule functions with pg_cron**

Run in Supabase SQL Editor:

```sql
-- 9am and 5pm weekdays for price checks
select cron.schedule('check-prices', '0 9,17 * * 1-5',
  $$select net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/check-prices',
    headers := jsonb_build_object('Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'))
  )$$
);

-- 8am daily for vest reminders
select cron.schedule('check-vests', '0 8 * * *',
  $$select net.http_post(
    url := current_setting('app.settings.supabase_url') || '/functions/v1/check-vests',
    headers := jsonb_build_object('Authorization', 'Bearer ' || current_setting('app.settings.service_role_key'))
  )$$
);
```

**Step 8: Deploy Edge Functions**

```bash
npx supabase functions deploy send-push
npx supabase functions deploy check-prices
npx supabase functions deploy check-vests
```

**Step 9: Add push notification enable button to Settings**

In `src/pages/Settings.tsx`, add:
```typescript
import { subscribeToPush } from '@/lib/pushNotifications'
// In the Notifications card:
<Button onClick={subscribeToPush} variant="outline" className="w-full">Enable Push Notifications</Button>
```

**Step 10: Commit**

```bash
git add .
git commit -m "feat: add push notifications via Web Push API and Supabase Edge Functions"
```

---

## Phase 8: Polish and PWA

### Task 15: PWA Icons, Meta Tags, and Final Polish

**Files:**
- Create: `public/icon-192.png` (create a simple green-on-black mne icon)
- Create: `public/icon-512.png`
- Modify: `index.html`

**Step 1: Add meta tags to index.html**

```html
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="mne">
<meta name="theme-color" content="#0D0D0D">
<link rel="apple-touch-icon" href="/icon-192.png">
```

**Step 2: Verify PWA installability on iOS**

Open on iPhone Safari → Share → "Add to Home Screen". Should show mne icon and name.

**Step 3: Run full test suite**

```bash
npm run test
```
Expected: All tests pass

**Step 4: Build for production**

```bash
npm run build
```
Expected: No TypeScript errors, dist/ folder created

**Step 5: Final commit**

```bash
git add .
git commit -m "feat: finalize PWA meta tags and icons for iOS/macOS install"
```

---

## Summary of All Commits

1. `feat: scaffold Vite + React + TypeScript PWA`
2. `feat: configure Tailwind and shadcn/ui with dark Cryptix theme`
3. `feat: add React Router app shell with bottom tab navigation`
4. `feat: add Supabase schema migration and client setup`
5. `feat: add onboarding flow with API key collection and Supabase auth`
6. `feat: add typed data access layer and portfolio computation helpers`
7. `feat: implement Home screen with net worth headline and expandable breakdowns`
8. `feat: implement Portfolio screen with expandable position and tax lot cards`
9. `feat: implement Tax screen with gains summary and harvest candidates`
10. `feat: implement Watchlist and Settings screens`
11. `feat: add JSON import and export with Moola-compatible format`
12. `feat: add command bar UI with ⌘K trigger and result display`
13. `feat: integrate Claude API for natural language command bar`
14. `feat: add push notifications via Web Push API and Supabase Edge Functions`
15. `feat: finalize PWA meta tags and icons for iOS/macOS install`
